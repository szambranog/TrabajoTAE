---
title: 'Predicción de la satisfacción de niñxs y abuelxs'
author: 'Esteban Rojas Henao'
date: '25/4/2022'
output:
 html_document:
        toc: true
        theme: united
        number_sections: true
        highlight: haddock
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(python = reticulate::eng_python, echo = FALSE, warning = FALSE, message = FALSE)
```

```{r librerias}
library(corrplot)
library(skimr)
library(ggplot2)
library(reshape2)
library(reticulate)
#use_python('/usr/bin/python3')
```

# Lectura de datos

Se lee un conjunto de datos sobre información del hogar, estos datos son tomados de la [Encuesta Nacional de Calidad de Vida](https://microdatos.dane.gov.co/index.php/catalog/MICRODATOS/about_collection/8/?per_page=15).
La definición de las variables que se consideran se puede encontrar en [Diccionario Encuesta Nacional de Calidad de Vida](https://microdatos.dane.gov.co/index.php/catalog/718/data_dictionary)

```{python lectura_bd}
import generar_dataframes

reporte = """Para niñxs se tienen las siguientes variables: P6020, P6040, P6081, P6083, P6080, prom_satisfaccion, num_ninxs, num_adultxs, num_abuelxs, P171, trabaja, dinero, P6160, P8586, P6090, P6100, P8551, P799S2, P799S3, P799S1, P799S4, P799S5, P3176, P1930, P1906S1, P1906S2, P1906S3, P1906S4, P1906S5, P1906S6, P1906S7, P1906S8, P3008S1, P3008S2, P1707, P3003, P1708, P1708S1, P5452, P6161S1, P51, P771, P772, P773, P58, actividad
Para abuelxs se tienen las siguientes variables: P6020, P6040, P5502, P6071, P6080, prom_satisfaccion, num_ninxs, num_adultxs, num_abuelxs, P6160, P8586, P8587, P6090, P6100, P8551, P799S2, P799S3, P799S1, P799S4, P799S5, P3176, P1930, P1906S1, P1906S2, P1906S3, P1906S4, P1906S5, P1906S6, P1906S7, P1906S8, P3008S1, P3008S2, P1707, P3003, P1708, P1708S1, P5452, P6161S1, P6426, P3193, dinero_trabajo, dinero_extra"""

reporte = generar_dataframes.generarDataFrame()
```

Además, se crean las variables:

* **prom_satisfaccion:** Promedio de la satisfacción de la persona. LOs valores nulos son calculados como el promedio de la satisfacción del hogar
* **num_ninxs:** Número de niñxs en el hogar
* **num_adultxs:** Número de personas entre 12 y 60 años en el hogar
* **num_abuelxs:** Número de abuelxs en el hogar
* **trabaja:** 1. Trabaja, 0. No trabaja
* **dinero:** Dinero conseguido por el trabajo
* **actividad:** Frecuencia con la que realiza una actividad de la lista de Atención integral
* **dinero_trabajo:** Dinero conseguido por el trabajo
* **dinero_extra:** Dinero conseguido por factores diferentes al trabajo

```{r lectura_bd_r}
df_ninxs = read.csv('ninxs.csv')
df_abuelxs = read.csv('abuelxs.csv')
```

```{r summary_niñxs}
skim(df_ninxs)
```

```{r summary_abuelxs}
skim(df_abuelxs)
```

```{r colores}
cols = c('darkcyan', 'darkkhaki', 'brown3', 'darkorange1', 'darkorchid', 'burlywood4', 'chartreuse3', 'darkgoldenrod2', 'dodgerblue', 'forestgreen', 'lightcoral', 'darkslateblue', 'indianred', 'steelblue', 'darkmagenta')
```

# Análisis exploratorio

## Edad {.tabset .tabset-fade}

### Niñxs

```{r edad_niñxs}
tbl <- with(df_ninxs, table(P6040))
barp <- barplot(tbl, beside=TRUE, col=cols, main='Número de personas por rango de edad', xlab='Edad (en años)', ylab='Número de personas', ylim=c(0, max(tbl)+200))

text(barp, tbl + 30, labels = tbl)

legend('top', fill=cols, legend=c(0:12), horiz=TRUE, cex=0.9, x.intersp=0.2, y.intersp=0.85)
```

Vemos que la mayoría de niñxs tienen 12 años (617), mientras que 1 año es la edad donde menos niñxs hay (416), sin embargo la distancia entre el número de niñxs por cada año no es muy grande, no hay una edad que destaque en el conjunto de datos.

### Abuelxs {.tabset .tabset-pill}

#### Gráfico de barras

```{r edad_abuelxs}
df_abuelxs$group_edad <-ifelse(df_abuelxs$P6040 <= 65, 'A',
                        ifelse(df_abuelxs$P6040 <= 70, 'B',
                        ifelse(df_abuelxs$P6040 <= 75, 'C',
                        ifelse(df_abuelxs$P6040 <= 80, 'D',
                        ifelse(df_abuelxs$P6040 <= 105, 'E', NA)))))

tbl <- with(df_abuelxs, table(group_edad))
barp <- barplot(tbl, beside=TRUE, col=cols, main='Número de personas por rango de edad', xlab='Rango de edad (en años)', ylab='Número de personas', names.arg=c('60-65', '65-70', '70-75', '75-80', '>80'), ylim=c(0, max(tbl)+500))

text(barp, tbl + 120, labels = tbl)

legend('top', fill=cols, legend=c('60-65', '65-70', '70-75', '75-80', '>80'), horiz=TRUE, x.intersp=0.2, y.intersp=0.85)
```

#### Histograma

```{r hist_edad_abuelxs}
h <- hist(df_abuelxs$P6040, xlab='Edad', ylab='Frecuencia', main='Histograma de la edad', col=cols[8], ylim=c(0, 4000), labels=TRUE)
```

Para lxs abuelxs la mayoría se encuentra entre 60 y 65 años, a partir de ahí en cada grupo hay menos personas. Debido al número de personas mayores a 80 años, a partir de esta edad se agrupan en un único grupo y no se divide en intervalos de 5 años.

## Satisfacción {.tabset .tabset-fade}

### Niñxs {.tabset .tabset-pill}
Veremos el nivel de satisfacción de lxs niñxs

#### Gráficos de barras

```{r bar_satisfaccion_ni}
par(mfrow=c(2, 3))
barp <- barplot(table(df_ninxs$P1895), beside=TRUE, col=cols[1], main='Satisfacción Vida', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_ninxs$P1895) + 100, labels = table(df_ninxs$P1895), cex=0.8)
barp <- barplot(table(df_ninxs$P1896), beside=TRUE, col=cols[2], main='Satisfacción Ingreso', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 4500))
text(barp, table(df_ninxs$P1896) + 100, labels = table(df_ninxs$P1896), cex=0.8)
barp <- barplot(table(df_ninxs$P1897), beside=TRUE, col=cols[3], main='Satisfacción Salud', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_ninxs$P1897) + 100, labels = table(df_ninxs$P1897), cex=0.8)
barp <- barplot(table(df_ninxs$P1898), beside=TRUE, col=cols[4], main='Satisfacción Seguridad', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_ninxs$P1898) + 100, labels = table(df_ninxs$P1898), cex=0.8)
barp <- barplot(table(df_ninxs$P1899), beside=TRUE, col=cols[5], main='Satisfacción Trabajo', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 2500))
text(barp, table(df_ninxs$P1899) + 100, labels = table(df_ninxs$P1899), cex=0.8)
barp <- barplot(table(df_ninxs$P3175), beside=TRUE, col=cols[6], main='Satisfacción Tiempo libre', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 2500))
text(barp, table(df_ninxs$P3175) + 100, labels = table(df_ninxs$P3175), cex=0.8)
```

Vemos que en todas predomina el *8* como respuesta, a excepción de la **Satisfacción Ingreso**, donde  la gran mayoría (4086 de 8173) son *10*. Ahora veamos como se comporta la satisfacción promedio

#### Histograma promedio

```{r hist_satisfaccion_ni}
h <- hist(df_ninxs$prom_satisfaccion, xlab='Satisfacción (0-10)', ylab='Frecuencia', main='Histograma de la satisfacción promedio', col=cols[14], ylim=c(0, 3000))
text(h$mids, h$counts + 100, labels = h$counts, cex=0.8)
```

Vemos que hay una tendencia a *7*, donde es el pico de frecuencia.

#### Correlación

```{r correlacion_satisfaccion_ni}
res <- cor(df_ninxs[c('P1895', 'P1896', 'P1897', 'P1898', 'P1899', 'P3175')])
corrplot(res, type = 'upper', tl.col = 'black', tl.srt=45, sig.level=0.5, insig='blank', method='pie', addCoef.col = 'black')
```

Vemos que las las variables con mayor correlación son **Satisfacción Vida** con **Satisfacción Ingreso** (66%) y **Satisfacción Vida** con **Satisfacción Tiempo libre** (62%)

### Abuelxs {.tabset .tabset-pill}

Veremos el nivel de satisfacción de lxs abuelxs

#### Gráficos de barras

```{r barras_satisfaccion_abu}
par(mfrow=c(2, 3))

barp <- barplot(table(df_abuelxs$P1895), beside=TRUE, col=cols[1], main='Satisfacción Vida', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_abuelxs$P1895) + 100, labels = table(df_abuelxs$P1895), cex=0.8)
barp <- barplot(table(df_abuelxs$P1896), beside=TRUE, col=cols[2], main='Satisfacción Ingreso', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_abuelxs$P1896) + 100, labels = table(df_abuelxs$P1896), cex=0.8)
barp <- barplot(table(df_abuelxs$P1897), beside=TRUE, col=cols[3], main='Satisfacción Salud', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_abuelxs$P1897) + 100, labels = table(df_abuelxs$P1897), cex=0.8)
barp <- barplot(table(df_abuelxs$P1898), beside=TRUE, col=cols[4], main='Satisfacción Seguridad', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_abuelxs$P1898) + 100, labels = table(df_abuelxs$P1898), cex=0.8)
barp <- barplot(table(df_abuelxs$P1899), beside=TRUE, col=cols[5], main='Satisfacción Trabajo', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 2500))
text(barp, table(df_abuelxs$P1899) + 100, labels = table(df_abuelxs$P1899), cex=0.8)
barp <- barplot(table(df_abuelxs$P3175), beside=TRUE, col=cols[6], main='Satisfacción Tiempo libre', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, 3000))
text(barp, table(df_abuelxs$P3175) + 100, labels = table(df_abuelxs$P3175), cex=0.8)
```

Vemos que en lxs abuelxs, el nivel de satisfacción se encuentra mayoritariamente en 8, seguido por 10, por abajo de 8 se nota que, entre menos valor, menos número de personas, a excepción del nivel de **satisfacción en el trabajo**, que en 0 tiene 341 respuestas.

#### Histograma promedio

```{r hist_satisfaccion_abu}
h <- hist(df_abuelxs$prom_satisfaccion, xlab='Satisfacción (0-10)', ylab='Frecuencia', main='Histograma de la satisfacción promedio', col=cols[10], ylim=c(0, 1500))
text(h$mids, h$counts + 100, labels = h$counts, cex=0.8)
```

#### Correlación

```{r correlacion_satisfaccion_abu}
res <- cor(df_abuelxs[c('P1895', 'P1896', 'P1897', 'P1898', 'P1899', 'P3175')])
corrplot(res, type = 'upper', tl.col = 'black', tl.srt=45, sig.level=0.5, insig='blank', method='pie', addCoef.col = 'black')
```

Vemos que las las variables con mayor correlación son **Satisfacción Vida** con **Satisfacción Ingreso** (52%) y **Satisfacción Salud** con **Satisfacción Trabajo** (50%)

```{r}
df_ninxs[c('P1895', 'P1896', 'P1897', 'P1898', 'P1899', 'P3175')] <- NULL
df_abuelxs[c('P1895', 'P1896', 'P1897', 'P1898', 'P1899', 'P3175')] <- NULL
```


## Composición del hogar {.tabset}

Veremos como se comportan las variables referentes a la composición del hogar

### Niñxs

```{r}
#nf <- layout(matrix(c(1, 2, 3, 4, 4, 4), nrow=2, byrow=TRUE))
par(mfrow=c(2, 3))

mytable <- table(df_ninxs$P6020)
pie(mytable, col=cols[4:5], main='Piechart sexo', labels = '')

legend('topleft', fill=cols[4:5], legend=c(paste0('Hombre: ', mytable[1]), paste0('Mujer: ', mytable[2])), cex=0.8, x.intersp=0.2, y.intersp=0.85)

tbl1 <- with(df_ninxs, table(P6081))
tbl2 <- with(df_ninxs, table(P6083))

tbl <- rbind(tbl1, tbl2)

barp <- barplot(tbl, beside=TRUE, col=cols[4:5], main='Vive con padres', xlab='Satisfacción (0-10)', ylab='Número de personas', ylim=c(0, max(tbl)+500), names.arg = c('Si', 'No', 'Fallecidx'))

text(barp, tbl + 300, labels = tbl, cex=0.9)

legend('bottomleft', fill=cols[4:5], legend=c('Padre', 'Madre'), cex=0.8, x.intersp=0.2, y.intersp=0.85)

barp <- barplot(table(df_ninxs$P6080), beside=TRUE, col=cols[15], main='Etnia', names.arg = c('Indígena', 'Gitanx', 'Raizal', 'Palenquerx', 'Afro', 'Ninguna'), las=2, ylab='Número de personas', ylim=c(0, 7200))
text(barp, table(df_ninxs$P6080) + 300, labels = table(df_ninxs$P6080), cex=0.8)

barp <- barplot(table(df_ninxs$num_ninxs), beside=TRUE, col=cols[14], main='Número de niñxs', ylab='Número de personas', ylim=c(0, 4200))
text(barp, table(df_ninxs$num_ninxs) + 300, labels = table(df_ninxs$num_ninxs), cex=0.8)

barp <- barplot(table(df_ninxs$num_adultxs), beside=TRUE, col=cols[13], main='Número de personas 12-60', ylab='Número de personas', ylim=c(0, 7200))
text(barp, table(df_ninxs$num_adultxs) + 300, labels = table(df_ninxs$num_adultxs), cex=0.8)

barp <- barplot(table(df_ninxs$num_abuelxs), beside=TRUE, col=cols[12], main='Número de abuelxs', ylab='Número de personas', ylim=c(0, 3200), las=2)
text(barp, table(df_ninxs$num_abuelxs) + 300, labels = table(df_ninxs$num_abuelxs), cex=0.8)
```

### Abuelxs

```{r}
nf <- layout(matrix(c(1, 2, 3, 4, 5, 6, 7, 7), nrow=2, byrow=TRUE))
#par(mfrow=c(2, 3))

mytable <- table(df_abuelxs$P6020)
pie(mytable, col=cols[4:5], main='Piechart sexo', labels = '')

legend('bottom', fill=cols[4:5], legend=c(paste0('Hombre: ', mytable[1]), paste0('Mujer: ', mytable[2])), cex=0.8, x.intersp=0.2, y.intersp=0.85)

barp <- barplot(table(df_abuelxs$P5502), beside=TRUE, col=cols[9:15], main='Situación sentimental', ylab='Número de personas', ylim=c(0, 7200), xaxt='n')
text(barp, table(df_abuelxs$P5502) + 300, labels = table(df_abuelxs$P5502), cex=0.8)

legend('top', fill=cols[9:15], legend=c('No casadx <2 años', 'No casadx >2 años', 'Viudx', 'Separadx', 'Solterx', 'Casadx'), cex=0.8, x.intersp=0.2, y.intersp=0.85)

mytable <- table(df_abuelxs$P6071)
pie(mytable, col=cols[7:9], main='Piechart vive\ncon cónyuge', labels = '')

legend('bottom', fill=cols[7:9], legend=c(paste0('Si: ', mytable[1]), paste0('No: ', mytable[2]), paste0('No responde: ', mytable[3])), cex=0.8, x.intersp=0.2, y.intersp=0.85)

barp <- barplot(table(df_abuelxs$P6080), beside=TRUE, col=cols[15], main='Etnia', names.arg = c('Indígena', 'Gitanx', 'Raizal', 'Palenquerx', 'Afro', 'Ninguna'), las=2, ylab='Número de personas', ylim=c(0, 8000))
text(barp, table(df_abuelxs$P6080) + 300, labels = table(df_abuelxs$P6080))

barp <- barplot(table(df_abuelxs$num_ninxs), beside=TRUE, col=cols[14], main='Número de niñxs', ylab='Número de personas', ylim=c(0, 6000))
text(barp, table(df_abuelxs$num_ninxs) + 300, labels = table(df_abuelxs$num_ninxs), cex=0.8)

barp <- barplot(table(df_abuelxs$num_adultxs), beside=TRUE, col=cols[13], main='Número de personas\n12-60 años', ylab='Número de personas', ylim=c(0, 6000))
text(barp, table(df_abuelxs$num_adultxs) + 300, labels = table(df_abuelxs$num_adultxs), cex=0.8)

barp <- barplot(table(df_abuelxs$num_abuelxs), beside=TRUE, col=cols[12], main='Número de abuelxs', ylab='Número de personas', ylim=c(0, 3200), las=2)
text(barp, table(df_abuelxs$num_abuelxs) + 300, labels = table(df_abuelxs$num_abuelxs), cex=0.8)
```

```{r}
summary(df_ninxs)

# Datos composición
```